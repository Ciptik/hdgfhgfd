name: Установка Docker и запуск Redis

on:
  workflow_dispatch:  # Запуск вручную из интерфейса GitHub
  push:
    branches: [ main ]  # Или по пушу в main, если нужно

jobs:
  setup-docker-and-redis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout репозитория (опционально)
        uses: actions/checkout@v4

      - name: Обновление пакетов
        run: sudo apt update

      - name: Установка зависимостей для Docker
        run: sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

      - name: Добавление GPG-ключа Docker
        run: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

      - name: Добавление репозитория Docker
        run: echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

      - name: Обновление пакетов после добавления репозитория
        run: sudo apt update

      - name: Установка Docker
        run: sudo apt install -y docker-ce docker-ce-cli containerd.io

      - name: Проверка установки Docker (hello-world)
        run: sudo docker run hello-world

      - name: Добавление пользователя в группу docker (чтобы не использовать sudo)
        run: sudo usermod -aG docker $USER

      # Примечание: В GitHub Actions перелогин не нужен — следующие команды уже могут работать без sudo благодаря правам runner'а.
      # Но для надёжности оставляем без sudo, если не сработает — добавьте sudo.

      - name: Загрузка образа Redis
        run: docker pull redis

      - name: Запуск контейнера Redis
        run: docker run -d --name my-redis -p 6379:6379 redis

      - name: Проверка работы Redis
        run: docker exec -it my-redis redis-cli ping
        # Ожидаемый вывод: PONG

      - name: Вывод списка запущенных контейнеров (для отчёта)
        run: docker ps
