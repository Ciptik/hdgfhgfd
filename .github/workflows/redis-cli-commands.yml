name: Комплексная практическая работа — Docker + Redis

on:
  workflow_dispatch:  # Ручной запуск из интерфейса GitHub
  push:
    branches: [ main ]  # Опционально: при пуше в main

jobs:
  setup-and-run-redis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout репозитория (опционально)
        uses: actions/checkout@v4

      - name: Обновление списка пакетов
        run: sudo apt update

      - name: Установка зависимостей для Docker
        run: sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

      - name: Добавление GPG-ключа Docker
        run: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

      - name: Добавление официального репозитория Docker
        run: echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

      - name: Обновление списка пакетов после добавления репозитория
        run: sudo apt update

      - name: Установка Docker Engine
        run: sudo apt install -y docker-ce docker-ce-cli containerd.io

      - name: Проверка установки Docker (hello-world)
        run: docker run hello-world

      - name: Загрузка официального образа Redis
        run: docker pull redis

      - name: Запуск контейнера Redis в фоновом режиме
        run: docker run -d --name my-redis -p 6379:6379 redis

      - name: Небольшая пауза для запуска Redis
        run: sleep 10

      - name: Проверка работы Redis (команда ping)
        run: docker exec my-redis redis-cli ping
        # Ожидаемый вывод: PONG

      - name: Вывод списка запущенных контейнеров (для отчёта)
        run: docker ps

      - name: Вывод логов Redis (дополнительно, для отчёта)
        run: docker logs my-redis | tail -20
